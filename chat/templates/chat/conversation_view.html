{% extends 'base.html' %}

{% block title %}Conversation Detail - {{ conversation.pk }} - {{ conversation.subject }}{% endblock %}

{% block head_script %}
  {% include 'scripts.html' with vue=True js_cookie=True debounce=True %}
  {% include 'chat/conversation_view.css' %}
{% endblock %}

{% block body_title %}Conversation Detail{% endblock body_title %}
{% block body_subheading %}#{{ conversation.pk }} -- {{ conversation.subject }}{% endblock %}

{% block content %}
<div id="app">

  <transition>
    <div v-if="menuShow" id="menu-overlay-parent-container" v-if="menuShow">
      <div key="overlayBackground" id="menu-overlay-background"></div>
      <div key="overlayMenu" id="menu-overlay-container">
        <div id="menu-overlay">
          <div @click="menuShow = !menuShow" class="menu-close-button-icon">X</div>
          <div id="menu-overlay-title">More Options</div>
          <div id="menu-overlay-item-container">
            <div @click="getUserList" class="menu-overlay-item bold cursor-url">- List conversation members</div>
            <div class="menu-overlay-item">
              <a href="{% url 'chat:conversation_update_participants' conversation_pk=conversation.pk %}" class="menu-overlay-item unstyled-link">- Add/Remove participants</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </transition>

  <p v-if="!messages.length">Say something to get the ball rolling!</p>
  <ul v-else-if="messages.length" class="chat-list" ref="chatList">
    <li v-for="message in messages.slice().reverse()"
        :key="message.pk"
        :id="'message' + message.pk"
        class="conversation-item"
        :class="messageContentClass(message)"
        :style="messageContentStyle(message)">

      <span>

        <span class="show-on-hover">([[ message.pk ]])</span>

        <span v-if="message.fields.sender !== userPk">[[ message.fields.sender_username ]]:</span>
        <span v-else style="font-weight: regular;">You:</span>

        <span @click="messageUpdatePanelSelect(message.pk)">
          [[ message.fields.content ]]
        </span>

        <transition>
          <span v-if="messageUpdatePanelValue === message.pk && userCanEdit(message)">

            <input type="text"
                   v-model="messageUpdatedContent"
                   @keyup.enter="messageUpdate(message.pk)">
            <button @click="messageUpdate(message.pk)">
              Update
            </button>
            <button @click="messageUpdatePanelSelect(message.pk)">
              Cancel
            </button>

            <span v-if="userCanEdit(message)">
              <strong v-if="!messageUpdateStatus && userIsStaff && message.fields.sender != userPk">&lt;-- Using admin privileges to edit</strong>
            </span>
            <span v-if="!userCanEdit(message)">
              You do not have permission to edit this message.
            </span>

          </span>
        </transition>

      </span>

    </li>
  </ul>

  <div id="message-container">
    <input id="message-input" type="text" v-model="messageInputText">
    <button @click="toggleMenu"
            id="menu-button"
            class="cursor-url"
            alt="Menu button"
            :style="{'background-color': menuShow ? '#33f' : '#555'}">
      &#9776;  <!-- hamburger menu icon -->
    </button>
    <button id="send-button"
            class="cursor-url"
            alt="Send button"
            :style="{'background-color': messageInputText ? '#33f' : '#555'}">
      &#9992; <!-- airplane emoji -->
    </button>
  </div>

  <div id="non-js-form">
  {% include 'base_form.html' %}
  </div>

  <transition>
    <div v-if="messageUpdateStatus" class="messageUpdateStatus">[[ messageUpdateStatus ]]</div>
  </transition>

</div>
{% endblock content %}

{% block body_end_script %}
  <script>
  {% include 'chat/conversation_view.js' %}
  </script>
{% endblock body_end_script %}
