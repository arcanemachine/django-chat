{% extends 'base.html' %}

{% block title %}Conversation Detail - {{ conversation.pk }} - {{ conversation.subject }}{% endblock %}

{% block head_script %}
  {% include 'scripts.html' with vue=True js_cookie=True helpers=True seedrandom=True lodash=True %}
  {% include 'chat/conversation_view.css' %}
{% endblock %}

{% block body_title %}Conversation{% endblock %}
{% block body_subheading %}{{ conversation.subject|truncatechars:20 }}{% endblock %}

{% block content %}
<div id="app">

  <transition>
    <div v-if="menuShow" id="menu-overlay-parent-container" v-if="menuShow">
      <div key="overlayBackground" id="menu-overlay-background"></div>
      <div key="overlayMenu" id="menu-overlay-container">
        <div id="menu-overlay">
          <div @click="menuShow = !menuShow" class="menu-close-button-icon">X</div>
          <div id="menu-overlay-title">More Options</div>
          <div id="menu-overlay-item-container">
            <div @click="getMessages" class="menu-overlay-item bold cursor-url">- Get new messages</div>
            <div @click="getUserList" class="menu-overlay-item bold cursor-url">- List conversation members</div>
            <div class="menu-overlay-item">
              <a href="{% url 'chat:conversation_update_participants' conversation_pk=conversation.pk %}" class="menu-overlay-item unstyled-link">- Add/Remove participants</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </transition>

  <p v-if="!messages.length">Say something to get the ball rolling!</p>
  <ul v-if="messages.length" class="chat-list" ref="chatList">
    <div v-if="allMessagesShown" class="mb-2 text-italic text-center">Beginning of conversation</div>
    <transition-group>
      <li v-if="deleteMe"
          v-for="message in messages.slice().reverse()"
          :key="message.pk"
          :id="'message' + message.pk"
          :ref="'message' + message.pk"
          class="conversation-item"
          :class="messageContentClass(message)"
          :style="messageContentStyle(message)">

        <span>

          <span v-if="message.fields.sender !== userPk">[[ message.fields.sender_username ]]:</span>
          <span v-else style="font-weight: regular;">You:</span>

          <span @click="messageUpdatePanelSelect(message.pk)">
            [[ message.fields.content ]]
          </span>

          <transition>
            <span v-if="messageUpdatePanelValue === message.pk && userCanEdit(message)">

              <input type="text"
                     v-model="messageUpdatedContent"
                     @keyup.enter="messageUpdate(message.pk)">
              <button @click="messageUpdate(message.pk)">
                Update
              </button>
              <button @click="messageUpdatePanelSelect(message.pk)">
                Cancel
              </button>

              <span v-if="userCanEdit(message)">
                <strong v-if="!messageUpdateStatus && userIsStaff && message.fields.sender != userPk">&lt;-- Using admin privileges to edit</strong>
              </span>
              <span v-if="!userCanEdit(message)">
                You do not have permission to edit this message.
              </span>

            </span>
          </transition>

        </span>

      </li>
    </transition>
  </ul>

  <div id="message-container">
    <input @keyup.enter="messageSend"
           id="message-input"
           type="text"
           v-model="messageInputText">
    <button @click="messageSend"
            id="send-button"
            class="cursor-url"
            alt="Send button"
            :style="{'background-color': messageInputText ? '#33f' : '#555'}">
      &#9992; <!-- airplane icon -->
    </button>
    <button @click="toggleMenu"
            id="menu-button"
            class="cursor-url"
            alt="Menu button"
            :style="{'background-color': menuShow ? '#33f' : '#555'}">
      &#9776;  <!-- hamburger menu icon -->
    </button>
  </div>

  <div id="non-js-form">
    {% include 'base_form.html' %}
  </div>

  <transition>
    <div v-if="messageUpdateStatus" class="message-update-status">[[ messageUpdateStatus ]]</div>
  </transition>

  <div>
    <button @click="deleteMe = !deleteMe" style="position: absolute; bottom: 10px; left: 0; right: 0; margin-left: auto; margin-right: auto">Toggle messages</button>
  </div>

</div>
{% endblock content %}

{% block body_end_script %}
  <script>
  {% include 'chat/conversation_view.js' %}
  </script>
{% endblock body_end_script %}
